<?php
use App\Utils\DB;
use App\Utils\Http;
use App\Utils\Response;
use App\Utils\Session;
use App\Utils\Storage;

Session::requireAuth();
$accountId = Session::getAccountId();
$uploadId = mb_substr(Http::getUri(), 9);

// Handle change name
if (isset($_POST['name'])) {
    $name = trim(strval($_POST['name']));
    $name = mb_substr($name, 0, UPLOAD_NAME_MAX_LENGTH);
    if (!empty($name)) {
        DB::query(
            'UPDATE uploads SET `name`=?s WHERE id=?s AND account=?i',
            $name,
            $uploadId,
            $accountId
        );
    }
    Response::redirect("/results/$uploadId");
}

// Handle change label
if (isset($_POST['label'])) {
    $label = strval($_POST['label']) ?: null;
    if ($label !== null && !isset(RESULTS_ALLOWED_RIBOTYPES[$label])) {
        Response::json([
            'success' => false,
            'error' => 'Invalid label',
        ], 400);
    }

    $rowCount = DB::query(
        'UPDATE uploads u
         LEFT JOIN samples s ON u.sample=s.digest
         SET u.label=?s, u.labeled_at=?s
         WHERE u.id=?s AND u.account=?i AND s.in_use=0',
        $label,
        gmdate('Y-m-d H:i:s'),
        $uploadId,
        $accountId
    )->rowCount();
    if ($rowCount == 0) {
        Response::json([
            'success' => false,
            'error' => 'Invalid sample',
        ], 400);
    }
    Response::json([
        'success' => true,
        'labelName' => RESULTS_ALLOWED_RIBOTYPES[$label] ?? null,
    ]);
}

// Handle delete
if ($_SERVER['REQUEST_METHOD'] === 'DELETE') {
    $digest = DB::getOne('SELECT sample FROM uploads WHERE id=?s AND account=?i', $uploadId, $accountId);
    if ($digest === false) {
        Response::json([
            'success' => false,
            'error' => 'Invalid sample',
        ], 400);
    }
    $digest = bin2hex($digest);

    // Delete upload row
    DB::query('DELETE FROM uploads WHERE id=?s', $uploadId);

    // Delete sample (if no longer in use by other accounts)
    $numberOfUsages = DB::getOne('SELECT COUNT(*) FROM uploads WHERE sample=x?s', $digest);
    if ($numberOfUsages == 0) {
        DB::query('DELETE FROM samples WHERE digest=x?s', $digest);
        Storage::deleteSample($digest);
    }

    Response::json(['success' => true]);
}

// Get sample details
$sample = DB::getRow(
    'SELECT u.id, u.name, u.label, u.uploaded_at, s.*
     FROM uploads u
     LEFT JOIN samples s ON s.digest=u.sample
     WHERE u.id=?s AND u.account=?i',
    $uploadId,
    $accountId
);
if ($sample === null) {
    $this->insert('not-found');
    return;
}
?>

<?php $this->layout('base', ['title' => 'Sample details']) ?>

<div class="container result-page">
    <div class="heading my-3">
        <h2 class="m-0">
            <?= $this->e($sample['name']) ?>
            <button type="button" title="Edit sample name" class="btn btn-sm btn-secondary btn-edit"><i class="bi bi-pencil-fill"></i></button>
        </h2>
        <form method="post" class="row d-none">
            <div class="col-md">
                <div class="input-group">
                    <input type="text" class="form-control" name="name" value="<?= $this->e($sample['name']) ?>">
                    <div class="input-group-append">
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </div>
            </div>
            <div class="col-md-auto mt-2 mt-md-0">
                <button type="button" class="btn btn-block btn-outline-secondary btn-cancel">Cancel</button>
            </div>
        </form>
    </div>

    <div class="row">
        <div class="col-md">
            <h3 class="h5 mt-3 text-uppercase text-muted">Results</h3>
            <table class="table table-xs table-hover table-borderless">
                <?php foreach (RESULTS_MODELS as $model=>$modelName) { ?>
                    <tr>
                        <th><?= $modelName ?> (<?= strtoupper($model) ?>)</th>
                        <td>
                            <?php if ($sample[$model.'_result'] === null) { ?>
                                <i class="bi bi-three-dots text-muted anim-breathing"></i>
                            <?php } else { ?>
                                <?= RESULTS_ALLOWED_RIBOTYPES[$sample[$model.'_result']] ?>
                                <?php if (isset($sample[$model.'_confidence'])) { ?>
                                    <?php $confidence = round($sample[$model.'_confidence']*100) ?>
                                    <?php $badge = ($confidence >= 90) ? 'success' : 'warning' ?>
                                    <span class="badge badge-pill badge-<?= $badge ?>"><?= $confidence ?>%</span>
                                <?php } ?>
                            <?php } ?>
                        </td>
                    </tr>
                <?php } ?>
                <tr>
                    <th>Actual label</th>
                    <td>
                        <?php if ($sample['in_use']) { ?>
                            <?= ($sample['label'] === null) ? 'Unspecified' : RESULTS_ALLOWED_RIBOTYPES[$sample['label']] ?>
                        <?php } else { ?>
                            <select class="form-control form-control-sm select-label">
                                <option value="" <?= ($sample['label'] === null) ? ' selected' : '' ?>>Unspecified</option>
                                <?php foreach (RESULTS_ALLOWED_RIBOTYPES as $value=>$text) { ?>
                                    <option value="<?= $value ?>"<?= ($sample['label'] == $value) ? ' selected' : '' ?>><?= $text ?></option>
                                <?php } ?>
                            </select>
                        <?php } ?>
                    </td>
                </tr>
            </table>
            <?php if ($sample['in_use']) { ?>
                <div class="alert alert-info" role="alert">
                    <strong>Thank you for your contribution! <i class="bi bi-heart-fill text-pink"></i></strong><br>
                    This sample is used to train our AI models. As such, it is no longer possible to modify the actual label.
                </div>
            <?php } ?>
        </div>
        <div class="col-md">
            <h3 class="h5 mt-3 text-uppercase text-muted">Metadata</h3>
            <table class="table table-xs table-hover table-borderless">
                <tr>
                    <th>Sample ID</th>
                    <td class="text-monospace"><?= preg_replace('/(?:^.{4})?.{4}\K/', '-', bin2hex($sample['sample_id']), 4) ?></td>
                </tr>
                <tr>
                    <th>Target ID</th>
                    <td class="text-monospace"><?= preg_replace('/(?:^.{4})?.{4}\K/', '-', bin2hex($sample['target_id']), 4) ?></td>
                </tr>
                <tr>
                    <th>Instrument <abbr title="Serial Number">SN</abbr></th>
                    <td><?= $sample['instrument_serial_number'] ?></td>
                </tr>
                <tr>
                    <th>Position</th>
                    <td><?= $sample['position'] ?></td>
                </tr>
                <tr>
                    <th>Spectrum size</th>
                    <td><?= $sample['spectrum_size'] ?></td>
                </tr>
                <tr>
                    <th>flexControl version</th>
                    <td><?= $sample['flexcontrol_version'] ?></td>
                </tr>
                <tr>
                    <th>AIDA version</th>
                    <td><?= $sample['aida_version'] ?></td>
                </tr>
                <tr>
                    <th>Acquired at</th>
                    <?php $acquiredAtTimestamp = strtotime($sample['acquired_at']) ?>
                    <td><time datetime="<?= $acquiredAtTimestamp ?>"><?= date('Y-m-d H:i:s', $acquiredAtTimestamp) ?></time></td>
                </tr>
                <tr>
                    <th>Calibrated at</th>
                    <?php $calibratedAtTimestamp = strtotime($sample['calibrated_at']) ?>
                    <td><time datetime="<?= $calibratedAtTimestamp ?>"><?= date('Y-m-d H:i:s', $calibratedAtTimestamp) ?></time></td>
                </tr>
                <tr>
                    <th>Uploaded at</th>
                    <?php $uploadedAtTimestamp = strtotime($sample['uploaded_at']) ?>
                    <td><time datetime="<?= $uploadedAtTimestamp ?>"><?= date('Y-m-d H:i:s', $uploadedAtTimestamp) ?></time></td>
                </tr>
            </table>
        </div>
    </div>
</div>

<?php $this->push('scripts') ?>
    <script src="https://cdn.jsdelivr.net/momentjs/2.18.1/moment.min.js"></script>
<?php $this->end() ?>
