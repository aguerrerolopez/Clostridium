<?php
use App\Utils\DB;
use App\Utils\Http;
use App\Utils\Response;
use App\Utils\Session;

Session::requireAuth();
$accountId = Session::getAccountId();
$uploadId = mb_substr(Http::getUri(), 9);

// Handle change upload label
if (isset($_POST['label'])) {
    $label = strval($_POST['label']);
    if (!isset(RESULTS_ALLOWED_RIBOTYPES[$label])) {
        Response::json([
            'success' => false,
            'error' => 'Invalid label',
        ], 400);
    }

    $rowCount = DB::query(
        'UPDATE uploads SET label=?s, labeled_at=?s WHERE id=?s AND account=?i',
        $label,
        gmdate('Y-m-d H:i:s'),
        $uploadId,
        $accountId
    )->rowCount();
    if ($rowCount == 0) {
        Response::json([
            'success' => false,
            'error' => 'Invalid sample',
        ], 400);
    }
    Response::json([
        'success' => true,
        'labelName' => RESULTS_ALLOWED_RIBOTYPES[$label],
    ]);
}
?>

<?php $this->layout('base', ['title' => 'Sample details']) ?>

<div class="container">
    <!-- // TODO: not implemented -->
    <?= $uploadId ?>
</div>
