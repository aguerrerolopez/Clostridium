<?php
use App\Utils\DB;
use App\Utils\Session;

Session::requireAuth();
$accountId = Session::getAccountId();

// Prepare pagination
$totalResults = DB::getOne(
    'SELECT COUNT(u.id)
     FROM uploads u
     WHERE u.account=?i',
    $accountId
);
$resultsPerPage = intval($_GET['limit'] ?? 0);
if (!in_array($resultsPerPage, RESULTS_ALLOWED_LIMITS, true)) {
    $resultsPerPage = RESULTS_ALLOWED_LIMITS[0];
}
$maxPage = ceil($totalResults / $resultsPerPage);
$currentPage = min(max(intval($_GET['page'] ?? 0), 1), $maxPage);

// Get results to show
$results = DB::getAll(
    'SELECT u.id, u.name, s.position, s.acquired_at
     FROM uploads u
     LEFT JOIN samples s ON s.digest=u.sample
     WHERE u.account=?i
     ORDER BY s.acquired_at DESC
     LIMIT ?i, ?i',
    $accountId,
    $resultsPerPage*($currentPage-1),
    $resultsPerPage
);
?>

<?php $this->layout('base', ['title' => 'Results']) ?>

<div class="container">
    <?php $this->insert('partials/verify-email-alert') ?>
    <div class="row mt-3 mb-4">
        <div class="col-lg-7">
            <form class="row no-gutters">
                <div class="col-md">
                    <div class="input-group input-group-sm">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                        </div>
                        <input class="form-control" type="text" value="Last 7 days">
                    </div>
                </div>
                <div class="col-md py-1 py-md-0 px-md-1">
                    <select class="custom-select custom-select-sm">
                        <option selected>All ribotypes</option>
                        <option value="1">RT-027</option>
                    </select>
                </div>
                <div class="col-md">
                    <div class="input-group input-group-sm">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                        </div>
                        <input class="form-control" type="text">
                    </div>
                </div>
            </form>
        </div>
        <div class="col-lg-5 d-flex align-items-center justify-content-end mt-2 mt-lg-0">
            <small class="text-muted">2 samples selected</small>
            <button type="button" class="btn btn-sm btn-info ml-2">
                <i class="bi bi-cloud-arrow-down-fill"></i>
                <span class="d-none d-sm-inline">Download ZIP</span>
            </button>
            <button type="button" class="btn btn-sm btn-secondary ml-1">
                <i class="bi bi-filetype-csv"></i>
                <span class="d-none d-sm-inline">Export CSV</span>
            </button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="results-table table table-sm table-hover">
            <thead>
                <tr>
                    <th scope="col">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="all-samples">
                            <label class="custom-control-label" for="all-samples"></label>
                        </div>
                    </th>
                    <th scope="col" class="col-name">Name</th>
                    <th scope="col">Position</th>
                    <th scope="col" class="text-nowrap">Acquired At</th>
                    <th scope="col" class="text-nowrap"><abbr title="Decision Tree">DT</abbr></th>
                    <th scope="col" class="text-nowrap"><abbr title="Random Forest">RF</abbr></th>
                    <th scope="col" class="text-nowrap"><abbr title="Factor Analysis Variational AutoEncoder">FAVAE</abbr></th>
                    <th scope="col" class="text-nowrap"><abbr title="Dual Bayesian Logistic Regressor">DBLR</abbr></th>
                    <th scope="col" class="text-nowrap">Actual</th>
                    <th scope="col"></th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($results as $index=>$result) { ?>
                    <tr>
                        <td>
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="sample-<?= $index ?>">
                                <label class="custom-control-label" for="sample-<?= $index ?>"></label>
                            </div>
                        </td>
                        <td><a href="/results/<?= $result['id'] ?>"><?= $this->e($result['name']) ?></a></td>
                        <td><?= $result['position'] ?></td>
                        <td><?= $result['acquired_at'] // TODO: format date ?></td>
                        <td><i class="bi bi-three-dots text-muted anim-breathing"></i></td>
                        <td><i class="bi bi-three-dots text-muted anim-breathing"></i></td>
                        <td><i class="bi bi-three-dots text-muted anim-breathing"></i></td>
                        <td><i class="bi bi-three-dots text-muted anim-breathing"></i></td>
                        <td>
                            <select class="form-control form-control-sm">
                                <option selected disabled>Add...</option>
                                <option>RT027</option>
                            </select>
                        </td>
                        <td class="col-buttons text-nowrap">
                            <a title="Download sample" href="/results/<?= $result['id'] ?>/download" class="btn btn-xs text-info"><i class="bi bi-cloud-arrow-down-fill"></i></a>
                            <button type="button" title="Delete sample" class="btn btn-xs text-danger"><i class="bi bi-trash-fill"></i></button>
                        </td>
                    </tr>
                <?php } ?>
            </tbody>
        </table>
    </div>
</div>
